<pre class="code">
<span class="srcline"><span class="lineno"><a href="27,1" id="srcline1"> 1</a></span><span class="line"><span class="keyword">function</span> <span class="var type1" id="S2T22U3">obst_group</span> = group_obstacles(<span class="var type1" id="S3T3U6">angle</span>, <span class="var type1" id="S4T3U7">distance</span>, <span class="var type2" id="S5T2V1U8">tolerance</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="27,2" id="srcline2"> 2</a></span><span class="line"><span class="comment">% Given the vector of angles and distaces measured by the lidar, return a</span></span></span>
<span class="srcline"><span class="lineno"><a href="27,3" id="srcline3"> 3</a></span><span class="line"><span class="comment">% cell of obstacles. Each element of the cell is an array of points</span></span></span>
<span class="srcline"><span class="lineno"><a href="27,4" id="srcline4"> 4</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="27,5" id="srcline5"> 5</a></span><span class="line"><span class="mxinfo " id="T23:U5"><span class="var type1" id="S2T23U11">obst_group</span>   = <span class="mxinfo " id="T24:U7">{}</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="27,6" id="srcline6"> 6</a></span><span class="line"><span class="mxinfo " id="T25:U8"><span class="var type1" id="S6T25U16">obstacle_vec</span> = <span class="mxinfo " id="T25:U10">[]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="27,7" id="srcline7"> 7</a></span><span class="line"><span class="mxinfo " id="T2:U11"><span class="var type1" id="S7T2U21">n_obs</span>        = <span class="mxinfo " id="T2:U13">0</span></span>; <span class="comment">% number of obstacles</span></span></span>
<span class="srcline"><span class="lineno"><a href="27,8" id="srcline8"> 8</a></span><span class="line"><span class="mxinfo " id="T2:U14"><span class="var type1" id="S8T2U25">toll</span>         = <span class="var type1" id="S5T2U26">tolerance</span></span>; <span class="comment">% two points are in the same obs if they are are closer than toll</span></span></span>
<span class="srcline"><span class="lineno"><a href="27,9" id="srcline9"> 9</a></span><span class="line"><span class="keyword">for</span> <span class="var type1" id="S9T2U29">i</span> = <span class="mxinfo " id="T26:U18"><span class="mxinfo " id="T2:U19">1</span>:<span class="mxinfo " id="T2:U20">length(<span class="var type1" id="S3T3U34">angle</span>)</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="27,10" id="srcline10">10</a></span><span class="line">    <span class="mxinfo " id="T2:U22"><span class="var type1" id="S11T2U37">r</span> = <span class="mxinfo " id="T2:U24"><span class="var type1" id="S4T3U39">distance</span>(<span class="var type1" id="S9T2U40">i</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="27,11" id="srcline11">11</a></span><span class="line">    <span class="keyword">if</span> isempty(<span class="var type1" id="S6T25U46">obstacle_vec</span>) &amp;&amp; (<span class="mxinfo " id="T7:U28">not(<span class="mxinfo " id="T7:U29"><span class="mxinfo " id="T7:U30">isnan(<span class="var type1" id="S11T2U53">r</span>)</span> || <span class="mxinfo " id="T7:U32">isinf(<span class="var type1" id="S11T2U56">r</span>)</span></span>)</span>) <span class="comment">% then start to fill an obstacle</span></span></span>
<span class="srcline"><span class="lineno"><a href="27,12" id="srcline12">12</a></span><span class="line">        <span class="mxinfo " id="T25:U34"><span class="var type1" id="S6T25U59">obstacle_vec</span> = <span class="mxinfo " id="T25:U36">[]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="27,13" id="srcline13">13</a></span><span class="line">        <span class="mxinfo " id="T25:U37"><span class="var type1" id="S6T25U64"><span class="message error" id="M19F37C">obstacle_vec</span></span></span> = <span class="mxinfo " id="T2:U38"><span class="fcn" id="F44N3:B66">custom_cat_vector</span>(<span class="var type1" id="S6T25U67">obstacle_vec</span>, <span class="var type1" id="S9T2U68">i</span>, <span class="mxinfo " id="T2:U41">2</span>)</span>; <span class="comment">% point i in the first obstacle</span></span></span>
<span class="srcline"><span class="lineno"><a href="27,14" id="srcline14">14</a></span><span class="line">        <span class="mxinfo " id="T2:U42"><span class="var type1" id="S7T2U72">n_obs</span> = <span class="mxinfo " id="T2:U44"><span class="var type1" id="S7T2U74">n_obs</span> + <span class="mxinfo " id="T2:U46">1</span></span></span>; <span class="comment">% there is a new obs</span></span></span>
<span class="srcline"><span class="lineno"><a href="27,15" id="srcline15">15</a></span><span class="line">    <span class="keyword">elseif</span> not(isempty(<span class="var type1" id="S6T25U81">obstacle_vec</span>)) <span class="comment">% i.e., I am already filling an obstacle</span></span></span>
<span class="srcline"><span class="lineno"><a href="27,16" id="srcline16">16</a></span><span class="line">        <span class="keyword">if</span> point_dist_polar(<span class="var type0" id="S6T0U89">obstacle_vec</span>(end), <span class="var type0" id="S9T0U92">i</span>, <span class="var type0" id="S3T0U93">angle</span>, <span class="var type0" id="S4T0U94">distance</span>) &lt; <span class="var type0" id="S8T0U95">toll</span> &amp;&amp; not(isnan(<span class="var type0" id="S11T0U101">r</span>) || isinf(<span class="var type0" id="S11T0U104">r</span>))</span></span>
<span class="srcline"><span class="lineno"><a href="27,17" id="srcline17">17</a></span><span class="line">            <span class="comment">%% continue to add to the obstacle</span></span></span>
<span class="srcline"><span class="lineno"><a href="27,18" id="srcline18">18</a></span><span class="line">            <span class="var type0" id="S6T0U107">obstacle_vec</span> = custom_cat_vector(<span class="var type0" id="S6T0U110">obstacle_vec</span>, <span class="var type0" id="S9T0U111">i</span>, 2); </span></span>
<span class="srcline"><span class="lineno"><a href="27,19" id="srcline19">19</a></span><span class="line">        <span class="keyword">elseif</span> not(isnan(<span class="var type0" id="S11T0U119">r</span>) || isinf(<span class="var type0" id="S11T0U122">r</span>)) <span class="comment">% then a new obs is needed</span></span></span>
<span class="srcline"><span class="lineno"><a href="27,20" id="srcline20">20</a></span><span class="line"><span class="comment">%             obst_group{n_obs} = obstacle_vec; %#ok&lt;SAGROW&gt;</span></span></span>
<span class="srcline"><span class="lineno"><a href="27,21" id="srcline21">21</a></span><span class="line">            <span class="var type0" id="S2T0U125">obst_group</span>        = custom_cat_cell(<span class="var type0" id="S2T0U128">obst_group</span>, <span class="var type0" id="S6T0U129">obstacle_vec</span>, 1);</span></span>
<span class="srcline"><span class="lineno"><a href="27,22" id="srcline22">22</a></span><span class="line">            <span class="var type0" id="S6T0U133">obstacle_vec</span>      = <span class="var type0" id="S9T0U134">i</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="27,23" id="srcline23">23</a></span><span class="line">            <span class="var type0" id="S7T0U137">n_obs</span>             = <span class="var type0" id="S7T0U139">n_obs</span> + 1;</span></span>
<span class="srcline"><span class="lineno"><a href="27,24" id="srcline24">24</a></span><span class="line">        <span class="keyword">elseif</span> isnan(<span class="var type0" id="S11T0U145">r</span>) || isinf(<span class="var type0" id="S11T0U148">r</span>)<span class="comment">% since not(isempty(obstacle_vec)) is true, I add the current non empty obs to the list</span></span></span>
<span class="srcline"><span class="lineno"><a href="27,25" id="srcline25">25</a></span><span class="line"><span class="comment">%             obst_group{n_obs} = obstacle_vec; %#ok&lt;SAGROW&gt;</span></span></span>
<span class="srcline"><span class="lineno"><a href="27,26" id="srcline26">26</a></span><span class="line">            <span class="var type0" id="S2T0U151">obst_group</span>        = custom_cat_cell(<span class="var type0" id="S2T0U154">obst_group</span>, <span class="var type0" id="S6T0U155">obstacle_vec</span>, 1);</span></span>
<span class="srcline"><span class="lineno"><a href="27,27" id="srcline27">27</a></span><span class="line">            <span class="var type0" id="S6T0U159">obstacle_vec</span>      = [];</span></span>
<span class="srcline"><span class="lineno"><a href="27,28" id="srcline28">28</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="27,29" id="srcline29">29</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="27,30" id="srcline30">30</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="27,31" id="srcline31">31</a></span><span class="line"><span class="comment">%% add the last obstacle</span></span></span>
<span class="srcline"><span class="lineno"><a href="27,32" id="srcline32">32</a></span><span class="line"><span class="keyword">if</span> <span class="mxinfo " id="T7:U48"><span class="var type1" id="S7T2U166">n_obs</span> &gt; <span class="mxinfo " id="T2:U50">0</span></span> &amp;&amp; <span class="mxinfo " id="T7:U51">not(<span class="mxinfo " id="T7:U52"><span class="mxinfo " id="T7:U53">isnan(<span class="mxinfo " id="T2:U54"><span class="var type1" id="S4T3U174">distance</span>(<span class="mxinfo " id="T2:U56">end</span>)</span>)</span> || <span class="mxinfo " id="T7:U57">isinf(<span class="mxinfo " id="T2:U58"><span class="var type1" id="S4T3U180">distance</span>(<span class="mxinfo " id="T2:U60">end</span>)</span>)</span></span>)</span></span></span>
<span class="srcline"><span class="lineno"><a href="27,33" id="srcline33">33</a></span><span class="line"><span class="comment">%     obst_group{n_obs} = obstacle_vec;</span></span></span>
<span class="srcline"><span class="lineno"><a href="27,34" id="srcline34">34</a></span><span class="line">    <span class="var type0" id="S2T0U185">obst_group</span>        = <span class="message error" id="M20F37C"><span class="fcn" id="F45N2:B187">custom_cat_cell</span>(<span class="var type1" id="S2T23U188">obst_group</span>, <span class="var type1" id="S6T25U189">obstacle_vec</span>, <span class="mxinfo " id="T2:U63">1</span>)</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="27,35" id="srcline35">35</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="27,36" id="srcline36">36</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="27,37" id="srcline37">37</a></span><span class="line"><span class="comment">%% now group obstacles (just first and last for now)</span></span></span>
<span class="srcline"><span class="lineno"><a href="27,38" id="srcline38">38</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="27,39" id="srcline39">39</a></span><span class="line"><span class="keyword">if</span> <span class="mxinfo " id="T7:U64"><span class="var type1" id="S7T2U195">n_obs</span> &gt; <span class="mxinfo " id="T2:U66">0</span></span> &amp;&amp; point_dist_polar(<span class="message error" id="M21F37C"><span class="var type1" id="S2T23U202">obst_group</span>{1}</span>(1), <span class="var type0" id="S2T0U207">obst_group</span>{end}(end), <span class="var type0" id="S3T0U212">angle</span>, <span class="var type0" id="S4T0U213">distance</span>) &lt; <span class="var type0" id="S8T0U214">toll</span></span></span>
<span class="srcline"><span class="lineno"><a href="27,40" id="srcline40">40</a></span><span class="line">    <span class="var type1" id="S2T23U218">obst_group</span>{<span class="mxinfo " id="T2:U69">1</span>} = [<span class="message error" id="M22F37C"><span class="var type1" id="S2T23U223">obst_group</span>{<span class="mxinfo " id="T2:U71">1</span>}</span>; <span class="var type1" id="S2T23U227">obst_group</span>{<span class="mxinfo " id="T2:U73">end</span>}];</span></span>
<span class="srcline"><span class="lineno"><a href="27,41" id="srcline41">41</a></span><span class="line">    <span class="var type0" id="S2T0U232">obst_group</span>    = <span class="message error" id="M23F37C"><span class="var type1" id="S2T23U234">obst_group</span>(1:end-1)</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="27,42" id="srcline42">42</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="27,43" id="srcline43">43</a></span><span class="line"><span class="comment">%% Delete obstacles with one point</span></span></span>
<span class="srcline"><span class="lineno"><a href="27,44" id="srcline44">44</a></span><span class="line"><span class="mxinfo " id="T27:U75"><span class="var type1" id="S20T27U243">obst_group_old</span> = <span class="var type1" id="S2T23U244">obst_group</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="27,45" id="srcline45">45</a></span><span class="line"><span class="mxinfo " id="T22:U78"><span class="var type1" id="S2T22U247">obst_group</span>     = <span class="mxinfo " id="T28:U80">{}</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="27,46" id="srcline46">46</a></span><span class="line"><span class="mxinfo " id="T2:U81"><span class="var type1" id="S7T2U252">n_obs</span>          = <span class="mxinfo " id="T2:U83">0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="27,47" id="srcline47">47</a></span><span class="line"><span class="keyword">for</span> <span class="var type1" id="S9T2U256">i</span> = <span class="mxinfo " id="T29:U85"><span class="mxinfo " id="T2:U86">1</span>:<span class="mxinfo " id="T2:U87">length(<span class="var type1" id="S20T27U261">obst_group_old</span>)</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="27,48" id="srcline48">48</a></span><span class="line">   <span class="keyword">if</span> length(<span class="var type0" id="S20T0U268">obst_group_old</span>{<span class="var type0" id="S9T0U269">i</span>}) &gt; 1</span></span>
<span class="srcline"><span class="lineno"><a href="27,49" id="srcline49">49</a></span><span class="line">       <span class="var type0" id="S7T0U273">n_obs</span>             = <span class="var type0" id="S7T0U275">n_obs</span> + 1;</span></span>
<span class="srcline"><span class="lineno"><a href="27,50" id="srcline50">50</a></span><span class="line">       <span class="var type0" id="S2T0U279">obst_group</span>        = custom_cat_cell(<span class="var type0" id="S2T0U282">obst_group</span>, <span class="var type0" id="S20T0U284">obst_group_old</span>{<span class="var type0" id="S9T0U285">i</span>}, 1);</span></span>
<span class="srcline"><span class="lineno"><a href="27,51" id="srcline51">51</a></span><span class="line">   <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="27,52" id="srcline52">52</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="27,53" id="srcline53">53</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="27,54" id="srcline54">54</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="27,55" id="srcline55">55</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="27,56" id="srcline56">56</a></span><span class="line"><span class="keyword">end</span></span></span>
</pre>
